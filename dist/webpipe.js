!function(t){function e(i){if(o[i])return o[i].exports;var n=o[i]={exports:{},id:i,loaded:!1};return t[i].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var o={};return e.m=t,e.c=o,e.p="",e(0)}([function(t,e,o){"use strict";function i(t){if(this.CLOSE_NORMAL=1e3,this.ATTEMPTS_MAX=100,this.BACKOFF_MAX=1200,this.HANDSHAKE="WEBPIPE1",!this)throw new Error('Must use "new" to create WebPipe instance.');void 0===t?t={}:"string"!=typeof t&&void 0===t.search||(t={path:t}),this._options={};var e=t||{};for(var o in e)this._options[o]=e[o];this._options.openAttemptsMax=this._options.openAttemptsMax||this.ATTEMPTS_MAX,this._options.backoffMax=this._options.backoffMax||this.BACKOFF_MAX,this._options.handshakeTimeout=this._options.handshakeTimeout||2e3,this._options.closePurgesQueued=this._options.closePurgesQueued||!0,this._logLevel=this._options.logLevel||(window.localStorage?localStorage.get("webpipe.log"):0)||0,this.name=this._options.name||"noname";var i=new n;this._events=i,this._replyEvents=new n,this._outgoing=[],this.on=i.on.bind(i),this.off=i.off.bind(i);var s=window.location,r="ws://"+(this._options.host||s.hostname)+":"+(this._options.port||s.port||80)+"/",p=this._options.path||"webpipe";"/"===p[0]&&(p=p.substring(1)),this._url=r+p;var h=this._open();return h?void(this._pipe=h):null}var n=o(1);i.prototype.is_open=function(){return 10===this._state},i.prototype.open=function(){return!!this.is_open()||(this._backoff=0,this._openAttempt=0,this._pipe=this._open(),this._pipe||this._openFailed(),!!this._pipe)},i.prototype._open=function(){this._state=1;var t=null;try{t=new WebSocket(this._url)}catch(e){return this._logLevel>=1&&console.error("WebSocket ctor FAIL:",e),this._handleRetries(),!1}return t&&this._bindEvents(t),t},i.prototype._openFailed=function(){this._events.emit("openfailed")},i.prototype._handleRetries=function(){var t=this._options.openAttemptsMax;if(this._openAttempt>t)return void this._openFailed();++this._openAttempt;var e=this._options.backoffMax;this._backoff>e?this._backoff=e:++this._backoff;var o=500+500*this._backoff;this._logLevel>=10&&console.log("retry in",o/1e3,"seconds");var i=this;setTimeout(function(){i._pipe=i._open()},o)},i.prototype._bindEvents=function(t){var e=this;t.onerror=function(t){e._events.emit("error",event),1===e._state&&(e.close(),e._handleRetries())},t.onopen=function(){function o(t){var o=JSON.parse(t.data);"replyTo"in o?e._replyEvents.emit(o.replyTo,o):e._events.emit(o.n,o.args||[])}e._state=10,e._backoff=0,e._openAttempt=0,t.onclose=function(t){e._state=0,e._pipe=null;var o=t.code!==e.CLOSE_NORMAL||!t.wasClean;e._events.emit("closed",t.code,o),o&&(this._logLevel>=10&&console.error("re-opening in 1 second..."),setTimeout(function(){e.open()},1e3))};var i=setTimeout(function(){throw new Error("WebPipe: No handshake received!")},e._options.handshakeTimeout);t.onmessage=function(n){if(n.data!==e.HANDSHAKE)throw t.close(),new Error("Invalid handshake received: "+n.data);e._logLevel>=3&&console.log("WebPipe: handshake OK"),t.onmessage=o,clearTimeout(i),i=null,t.send(e.HANDSHAKE),e._sendOutgoing(),e._events.emit("opened")}}},i.prototype._sendOutgoing=function(){var t=this._outgoing;this._outgoing=[];for(var e=this._pipe.send.bind(this._pipe),o=t.length,i=0;i<o;++i)e(t[i])},i.prototype.close=function(){this._pipe&&this._pipe.close(this.CLOSE_NORMAL,"WebPipe.close()"),this._pipe=null,this._state=0,this._options.closePurgesQueued&&(this._outgoing=[])},i.prototype.emit=function(t){function e(t){p._replyEvents.off(i.requestId,e),r.apply(void 0,t.args||[])}var o=arguments.length;if(0===o)return!1;var i={n:t};if(o>1){var n=arguments[arguments.length-1],s=arguments.length;if("function"==typeof n){i.requestId=(""+Math.random()).substring(2);var r=n;--s;var p=this;this._replyEvents.on(i.requestId,e)}i.args=Array.prototype.slice.call(arguments,1,s)}var h=JSON.stringify(i);this.is_open()?this._pipe.send(h):this._outgoing.push(h)}},function(t,e){"use strict";var o=function(){this._events={}};o.prototype={on:function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){if(t in this._events){var o=this._events[t].indexOf(e);this._events[t].splice(o,1)}},emit:function(t){if(t in this._events)for(var e=Array.prototype.slice.call(arguments,1),o=this._events[t],i=o.length,n=0;n<i;++n)o[n].apply(this,e)}},t.exports=o}]);